<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
  <link rel="stylesheet" href="../css/currentPlan.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar">
        <ul class="menu">
          <li><a href="start.html"><i class="fas fa-bullseye"></i> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</a></li>
          <li><a href="calendar.html"><i class="fas fa-calendar-alt"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</a></li>
          <li><a href="dashboard.html"><i class="fas fa-file-alt"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</a></li>
          
          <li class="has-submenu">
            <a href="#" class="toggle-submenu"><i class="fas fa-chart-line"></i> ‡∏•‡∏á‡∏ó‡∏∏‡∏ôDCA </a>
            <ul class="submenu">
              <li><a href="calculator.html">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ìDCA</a></li>
              <li><a href="dca-progress.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤DCA</a></li>
            </ul>
          </li>
    
          <li class="has-submenu">
            <a href="#" class="toggle-submenu"><i class="fas fa-credit-card"></i> ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡πà‡∏≠‡∏ô </a>
            <ul class="submenu">
                <li><a href="install-progress.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏°‡∏ú‡πà‡∏≠‡∏ô</a></li>
            </ul>
        </li>
    
          <li class="has-submenu">
            <a href="#" class="toggle-submenu"><i class="fas fa-piggy-bank"></i> ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô </a>
            <ul class="submenu">
              <li><a href="saving-progress.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</a></li>
            </ul>
          </li>
    
          <li><a href="emergencyfund-progress.html"><i class="fa-solid fa-shield-heart"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</a></li>
    
          <li><a href="showPlan.html"><i class="fas fa-cogs"></i> ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a></li>
        </ul>
    
        <div class="user-info">
          <div class="user-dropdown">
            üë§ <span class="user-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠...</span>
            <i class="fas fa-caret-up dropdown-icon"></i>
            <ul class="dropdown-menu">
              <li id="sign-out-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</li>
            </ul>
          </div>
        </div>
      </div>
        </div>
  </div>

  <div class="container">
    <header class="header">
      <h1 id="plan-title">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
    </header>

    <!-- ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô -->
    <section class="financial-status">
      <h2>‡∏ú‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h2>
      <div class="status-wrapper">
        <div class="status-box">
          <div id="saving-circle" class="circle"></div>
          <div id="saving-text" class="status-text"></div>
          <div id="saving-detail" class="status-detail"></div>
        </div>
        <div class="status-box">
          <div id="wealth-circle" class="circle"></div>
          <div id="wealth-text" class="status-text"></div>
          <div id="wealth-detail" class="status-detail"></div>
        </div>
        <div class="status-box">
          <div id="emergency-circle" class="circle"></div>
          <div id="emergency-text" class="status-text"></div>
          <div id="emergency-detail" class="status-detail"></div>
        </div>
      </div>
    </section>

    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
    <section class="plan-summary-section">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
      <div id="plan-summary"></div>
    </section>
  </div>

  <script type="module">
    import { db, auth } from "../javascript/firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get("type");
    const id = urlParams.get("id");

    const statusMap = {
      "‡∏î‡∏µ‡∏°‡∏≤‡∏Å": { color: "circle-green", icon: "fa-shield-heart" },
      "‡∏û‡∏≠‡πÉ‡∏ä‡πâ": { color: "circle-yellow", icon: "fa-face-meh" },
      "‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á": { color: "circle-red", icon: "fa-triangle-exclamation" }
    };

    function updateStatus(circleId, textId, detailId, status, detailText) {
      const circleEl = document.getElementById(circleId);
      const textEl = document.getElementById(textId);
      const detailEl = document.getElementById(detailId);
      const conf = statusMap[status];
      if (!circleEl || !textEl || !detailEl || !conf) return;
      circleEl.className = `circle ${conf.color}`;
      circleEl.innerHTML = `<i class="fa-solid ${conf.icon}"></i>`;
      textEl.textContent = status;
      detailEl.textContent = detailText;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        let planRef;
        if (type === "current") {
          planRef = doc(db, "plan", user.uid);
        } else if (type === "history" && id) {
          planRef = doc(db, "plan", user.uid, "planHistory", id);
        } else {
          document.getElementById("plan-title").textContent = "‚ùå URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
          return;
        }

        const snap = await getDoc(planRef);
        if (!snap.exists()) {
          document.getElementById("plan-title").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô";
          return;
        }

        const data = snap.data();
        document.getElementById("plan-title").textContent = type === "current" ? "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" : "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";

        // Read fields
        const { income, expense, debt, dcaInvested, savingsAmount, emergencyFund } = data;
        const totalInstallmentPaid = 0; // if needed, calculate if data includes it
        const savings = (dcaInvested || 0) + (savingsAmount || 0) + (emergencyFund || 0);
        const netAssets = income - expense - debt;
        const monthsCovered = expense > 0 ? emergencyFund / expense : 0;

        let savingsStatus = "‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á";
        let wealthStatus = "‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á";
        let emergencyStatus = "‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á";

        if (savings >= 0.10 * income) savingsStatus = "‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
        else if (savings >= 0.05 * income) savingsStatus = "‡∏û‡∏≠‡πÉ‡∏ä‡πâ";

        if (netAssets >= 0.50 * income) wealthStatus = "‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
        else if (netAssets >= 0.20 * income) wealthStatus = "‡∏û‡∏≠‡πÉ‡∏ä‡πâ";

        if (monthsCovered >= 6) emergencyStatus = "‡∏î‡∏µ‡∏°‡∏≤‡∏Å";
        else if (monthsCovered >= 3) emergencyStatus = "‡∏û‡∏≠‡πÉ‡∏ä‡πâ";

        updateStatus("saving-circle", "saving-text", "saving-detail", savingsStatus, `‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° ${((savings / income) * 100).toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ`);
        updateStatus("wealth-circle", "wealth-text", "wealth-detail", wealthStatus, `‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ${((netAssets / income) * 100).toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ`);
        updateStatus("emergency-circle", "emergency-text", "emergency-detail", emergencyStatus, `‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° ${monthsCovered.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);

        // ‡∏™‡∏£‡∏∏‡∏õ
        const summaryText = `‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:\n- ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°: ${savingsStatus}\n- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á: ${wealthStatus}\n- ‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°: ${monthsCovered.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${data.plan || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}`;
        document.getElementById("plan-summary").textContent = summaryText;
      } catch (err) {
        console.error(err);
        document.getElementById("plan-title").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô";
      }
    });
  </script>
</body>
</html>